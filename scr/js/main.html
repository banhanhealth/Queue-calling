<script>
// ฟังก์ชันสำหรับแสดง section ที่ต้องการและซ่อน section อื่น (ย้ายมาจาก index.html)
function showSection(sectionId) {
  console.trace('showSection called with:', sectionId);
  const sections = [
    'loginForm',
    'dashboard',
    // 'userSection',
    // 'displaySection',
    'adminSection',
    'settingsSection' // Changed from initSection
  ];

 

  sections.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      if (id === sectionId) {
        el.classList.remove('hidden');
        sessionStorage.setItem('lastContent', id);  
        // If settingsSection is shown, call its data loading functions
        if (id === 'settingsSection' && typeof onShowSettingsSection === 'function') {
          onShowSettingsSection();
        }
        // Add a similar hook for userSection
        if (id === 'userSection' && typeof onShowUserSection === 'function') {
          onShowUserSection();
        }
      } else {
        el.classList.add('hidden');
      }
    }
  });
}



// ฟังก์ชันสำหรับการจัดรูปแบบวันที่และเวลา
function formatDateTime(date) {
  if (!date) return '';
  
  if (typeof date === 'string') {
    date = new Date(date);
  }
  
  const day = date.getDate().toString().padStart(2, '0');
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const year = date.getFullYear();
  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');
  
  return `${day}/${month}/${year} ${hours}:${minutes}`;
}

// ฟังก์ชันสำหรับการจัดรูปแบบเวลา
function formatTime(date) {
  if (!date) return '';
  
  if (typeof date === 'string') {
    date = new Date(date);
  }
  
  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');
  
  return `${hours}:${minutes}`;
}

// เมื่อหน้าเว็บโหลดเสร็จ
document.addEventListener('DOMContentLoaded', function() {
  
  // ตรวจสอบปุ่มออกจากระบบ (ถ้ามี)
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      google.script.run
        .withSuccessHandler(() => {
          // เคลียร์ข้อมูลผู้ใช้ใน UI
          const userInfo = document.getElementById('userInfo');
          if (userInfo) {
            userInfo.textContent = '';
          }
          const usernameInput = document.getElementById('username');
          if (usernameInput) {
            usernameInput.value = '';
          }
          const passwordInput = document.getElementById('password');
          if (passwordInput) {
            passwordInput.value = '';
          }
          // แสดงหน้า login
          sessionStorage.removeItem('lastContent');
          showSection('loginForm');
        })
        .withFailureHandler((err) => {
          console.error('Logout failed:', err);
          showAlert('Logout failed. Please try again.', 'error');
          showSection('loginForm'); // พยายามแสดงหน้า login แม้จะเกิดข้อผิดพลาด
        })
        .logout();
    });
  }

  // --- Global Utility Functions ---
window.showAppConfirmationDialog = function(message, onConfirm, onCancel, confirmButtonClass = "bg-red-600 hover:bg-red-700", confirmButtonText = "ยืนยัน") {
    // Remove existing dialog if any
    const existingDialog = document.getElementById("appConfirmationOverlay");
    if (existingDialog) {
      existingDialog.remove();
    }

    const overlay = document.createElement("div");
    overlay.id = "appConfirmationOverlay";
    overlay.className = "fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[100] p-4"; // Increased z-index

    const dialog = document.createElement("div");
    dialog.className = "bg-white p-6 rounded-lg shadow-xl max-w-md w-full";

    const messageP = document.createElement("p");
    messageP.className = "text-gray-800 text-base mb-6";
    messageP.textContent = message;

    const buttonDiv = document.createElement("div");
    buttonDiv.className = "flex justify-end gap-3";

    const confirmBtn = document.createElement("button");
    confirmBtn.className = `${confirmButtonClass} text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors`;
    confirmBtn.textContent = confirmButtonText;
    confirmBtn.onclick = () => {
      if (onConfirm) onConfirm();
      overlay.remove();
    };

    const cancelBtn = document.createElement("button");
    cancelBtn.className = "bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg text-sm font-medium transition-colors";
    cancelBtn.textContent = "ยกเลิก";
    cancelBtn.onclick = () => {
      if (onCancel) onCancel();
      overlay.remove();
    };

    buttonDiv.appendChild(cancelBtn);
    buttonDiv.appendChild(confirmBtn);
    dialog.appendChild(messageP);
    dialog.appendChild(buttonDiv);
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
  }
console.log("js/main.html: window.showAppConfirmationDialog is now defined globally.", typeof window.showAppConfirmationDialog);

window.showAppToastNotification = function(message, type = "info", duration = 3000) {
    const notification = document.createElement("div");
    let bgColor = "bg-blue-500"; // Default info
    if (type === "success") bgColor = "bg-green-500";
    if (type === "error") bgColor = "bg-red-500";
    if (type === "warning") bgColor = "bg-yellow-500 text-black"; // Yellow often needs black text

    notification.className = `fixed top-5 right-5 ${bgColor} text-white px-6 py-3 rounded-lg shadow-xl z-[105] transition-all duration-300 ease-out opacity-0 transform translate-x-full`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => { notification.classList.remove("opacity-0", "translate-x-full"); notification.classList.add("opacity-100", "translate-x-0"); }, 100); // Slide in and fade in
    setTimeout(() => { notification.classList.remove("opacity-100", "translate-x-0"); notification.classList.add("opacity-0", "translate-x-full"); setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 350); }, duration); // Slide out and fade out
  }
});
</script>
