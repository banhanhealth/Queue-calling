<!-- d:\Github\Queue-augment\js\settings.html -->
<script>
  console.log("js/settings.html: Script execution started. Checking for showAppConfirmationDialog:", typeof showAppConfirmationDialog);

   /**
 * Initializes interactions for the settings page, including tab switching
 * and button event listeners. This function should be called when the
 * settings section/page is made visible.
 */
function initializeSettingsPageInteractions() {
    console.log("Attempting to initialize settings page interactions from js/settings.html...");

    const settingsTabsContainer = document.getElementById('settingsTabs');
    const initSystemBtn = document.getElementById('runInitializeSystemBtn');
    const initSystemMessage = document.getElementById('initSystemMessage');
    // const generalSettingsFormArea = document.getElementById('generalSettingsFormArea'); // For future use
    // const soundManagementArea = document.getElementById('soundManagementArea'); // For future use
    // const announcementSettingsArea = document.getElementById('announcementSettingsContent'); // For future use

    // Tab switching logic
    if (settingsTabsContainer) {
        const tabButtons = Array.from(settingsTabsContainer.querySelectorAll('.settings-tab-button'));
        const tabPanesContainer = document.getElementById('settingsTabContent');

        if (!tabPanesContainer) {
            console.error("Element with ID 'settingsTabContent' not found. Tab panes cannot be managed.");
            // return; // Allow other initializations to proceed
        } else {
            const tabPanes = Array.from(tabPanesContainer.querySelectorAll('.settings-tab-pane'));

            function activateTab(buttonToActivate) {
                if (!buttonToActivate) return;

                tabButtons.forEach(btn => {
                    btn.setAttribute('aria-selected', 'false');
                    // Tailwind classes for inactive tabs (adjust if your default HTML is different)
                    btn.classList.remove('border-indigo-500', 'text-indigo-600', 'font-semibold', 'bg-indigo-50');
                    btn.classList.add('border-transparent', 'hover:text-gray-700', 'hover:border-gray-300', 'text-gray-500');
                });

                tabPanes.forEach(pane => {
                    pane.classList.add('hidden');
                });

                buttonToActivate.setAttribute('aria-selected', 'true');
                // Tailwind classes for active tab
                buttonToActivate.classList.add('border-indigo-500', 'text-indigo-600', 'font-semibold', 'bg-indigo-50');
                buttonToActivate.classList.remove('border-transparent', 'hover:text-gray-700', 'hover:border-gray-300', 'text-gray-500');

                const targetPaneId = buttonToActivate.dataset.tabsTarget; // Ensure buttons have data-tabs-target="#paneId"
                if (targetPaneId) {
                    const targetPane = tabPanesContainer.querySelector(targetPaneId);
                    if (targetPane) {
                        targetPane.classList.remove('hidden');
                    } else {
                        console.error(`Target pane ${targetPaneId} not found.`);
                    }
                }
            }

            let activeTabButton = tabButtons.find(btn => btn.getAttribute('aria-selected') === 'true');
            if (!activeTabButton && tabButtons.length > 0) {
                activeTabButton = tabButtons[0]; // Default to the first tab
            }
            
            if (activeTabButton) {
                activateTab(activeTabButton); // Initialize the view for the active tab
            }

            tabButtons.forEach(button => {
                if (button.dataset.tabListenerAttached !== 'true') {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
                        activateTab(this);
                    });
                    button.dataset.tabListenerAttached = 'true';
                }
            });
            console.log("Settings tab listeners attached/verified by initializeSettingsPageInteractions.");
        }
    } else {
        console.warn("Element with ID 'settingsTabs' not found. Tab functionality will not work.");
    }

    // "Initialize System" button logic (replaces the one in DOMContentLoaded)
    if (initSystemBtn) {
        if (initSystemBtn.dataset.initListenerAttached !== 'true') { // Use a unique dataset property
            initSystemBtn.addEventListener('click', handleInitializeSystem); // handleInitializeSystem is already defined below
            initSystemBtn.dataset.initListenerAttached = 'true';
            console.log("Initialize System button listener attached by initializeSettingsPageInteractions.");
        }
    } else {
        console.warn("Element with ID 'runInitializeSystemBtn' not found by initializeSettingsPageInteractions.");
    }
    console.log("Settings page interactions initialized or verified by initializeSettingsPageInteractions.");
}

// --- Slideshow Image Management Functions (Admin) ---
function loadAdminSlideshowImages() {
    const tableBody = document.getElementById('slideshowImagesTableBodyAdmin');
    const messageDiv = document.getElementById('slideshowImagesTableMessageAdmin');

    if (!tableBody || !messageDiv) {
        console.error("Slideshow Images: Table body or message div not found in settings.");
        return;
    }

    messageDiv.textContent = "กำลังโหลดข้อมูลรูปภาพ...";
    messageDiv.className = "mt-2 text-sm text-purple-600"; // Default message class
    tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-center">กำลังโหลดข้อมูลรูปภาพ...</td></tr>';

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success && response.data) {
                if (response.data.length > 0) {
                    populateSlideshowImagesTableAdmin(response.data);
                    messageDiv.textContent = ""; // Clear loading message on success
                } else {
                    messageDiv.textContent = "ไม่พบข้อมูลรูปภาพสไลด์โชว์";
                    tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-center">ไม่พบข้อมูลรูปภาพ</td></tr>';
                }
            } else {
                messageDiv.textContent = response.message || "เกิดข้อผิดพลาดในการโหลดข้อมูลรูปภาพ";
                messageDiv.className = "mt-2 text-sm text-red-600";
                tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-center">เกิดข้อผิดพลาดในการโหลดข้อมูล</td></tr>';
            }
        })
        .withFailureHandler(function(error) {
            messageDiv.textContent = "เกิดข้อผิดพลาดในการเชื่อมต่อ: " + error.message;
            messageDiv.className = "mt-2 text-sm text-red-600";
            tableBody.innerHTML = '<tr><td colspan="7" class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 text-center">เกิดข้อผิดพลาดในการเชื่อมต่อ</td></tr>';
            console.error("Error in getAllSlideshowImagesAdmin call:", error);
        })
        .getAllSlideshowImagesAdmin();
}

function populateSlideshowImagesTableAdmin(images) {
    const tableBody = document.getElementById('slideshowImagesTableBodyAdmin');
    if (!tableBody) {
        console.error("Slideshow Images: Table body not found for population in settings.");
        return;
    }

    tableBody.innerHTML = ""; // Clear any previous content

    images.forEach(image => {
        const row = tableBody.insertRow();
        row.innerHTML = `
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${image.id}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                <img src="${image.imageUrl}" alt="${escapeJsString(image.title)}" class="w-20 h-12 object-cover rounded" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=&quot;text-xs text-red-500&quot;>โหลดภาพไม่ได้</span>';">
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${escapeJsString(image.title)}</td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs" title="${escapeJsString(image.imageUrl)}">${escapeJsString(image.imageUrl)}</td>
            <td class="px-4 py-3 text-center whitespace-nowrap text-sm text-gray-500">${image.displayOrder}</td>
            <td class="px-4 py-3 text-center whitespace-nowrap text-sm text-gray-500">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${image.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${image.isActive ? 'ใช่' : 'ไม่'}
                </span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">
                <button onclick="openViewSlideshowImageModal('${escapeJsString(image.imageUrl)}', '${escapeJsString(image.title)}')" class="text-blue-600 hover:text-blue-900 mr-2" title="ดูภาพ">ดู</button>
                <button onclick="openEditSlideshowImageModal('${image.id}', '${escapeJsString(image.imageUrl)}', '${escapeJsString(image.title)}', '${image.displayOrder}', ${image.isActive})" class="text-indigo-600 hover:text-indigo-900 mr-2" title="แก้ไข">แก้ไข</button>
                <button onclick="deleteSlideshowImage('${image.id}')" class="text-red-600 hover:text-red-900" title="ลบ">ลบ</button>
            </td>
        `;
    });
}

// This escapeJsString function was already provided and should be here or globally available.
// function escapeJsString(str) {
//     if (typeof str !== 'string') return '';
//     return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
// }
// --- END Slideshow Image Management Functions (Admin) ---

// --- Slideshow Image Modal Functions ---
function openViewSlideshowImageModal(imageUrl, imageTitle) {
    const modal = document.getElementById('viewSlideshowImageModal');
    const imgPreview = document.getElementById('viewSlideshowImagePreview');
    const imgCaption = document.getElementById('viewSlideshowImageCaption');

    if (modal && imgPreview && imgCaption) {
        imgPreview.src = imageUrl;
        imgPreview.alt = imageTitle || "Image Preview";
        imgCaption.textContent = imageTitle || "";
        modal.classList.remove('hidden');
    } else {
        console.error("View Slideshow Image Modal or its elements not found.");
    }
}

function closeViewSlideshowImageModal() {
    const modal = document.getElementById('viewSlideshowImageModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function openAddSlideshowImageModal() {
    const modal = document.getElementById('addSlideshowImageModal');
    if (modal) {
        // Clear previous values
        document.getElementById('newSlideshowImageUrl').value = '';
        document.getElementById('newSlideshowImageTitle').value = '';
        document.getElementById('newSlideshowImageOrder').value = '';
        document.getElementById('newSlideshowImageIsActive').checked = true;
        document.getElementById('addSlideshowImageModalMessage').textContent = '';
        modal.classList.remove('hidden');
    } else {
        console.error("Add Slideshow Image Modal not found.");
    }
}

function closeAddSlideshowImageModal() {
    const modal = document.getElementById('addSlideshowImageModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function saveNewSlideshowImage() {
    const imageUrl = document.getElementById('newSlideshowImageUrl').value.trim();
    const title = document.getElementById('newSlideshowImageTitle').value.trim();
    const displayOrder = parseInt(document.getElementById('newSlideshowImageOrder').value);
    const isActive = document.getElementById('newSlideshowImageIsActive').checked;
    const messageDiv = document.getElementById('addSlideshowImageModalMessage');

    if (!imageUrl) {
        messageDiv.textContent = 'กรุณากรอก URL รูปภาพ';
        messageDiv.className = 'px-6 py-2 text-sm text-red-600';
        return;
    }
    // Basic URL validation (can be more sophisticated)
    try {
        new URL(imageUrl);
    } catch (_) {
        messageDiv.textContent = 'URL รูปภาพไม่ถูกต้อง';
        messageDiv.className = 'px-6 py-2 text-sm text-red-600';
        return;
    }
    if (isNaN(displayOrder)) {
        messageDiv.textContent = 'กรุณากรอกลำดับการแสดงผลเป็นตัวเลข';
        messageDiv.className = 'px-6 py-2 text-sm text-red-600';
        return;
    }

    messageDiv.textContent = 'กำลังบันทึก...';
    messageDiv.className = 'px-6 py-2 text-sm text-blue-600';

    const imageData = {
        imageUrl: imageUrl,
        title: title,
        displayOrder: displayOrder,
        isActive: isActive
    };

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageDiv.textContent = response.message || 'เพิ่มรูปภาพสำเร็จ!';
                messageDiv.className = 'px-6 py-2 text-sm text-green-600';
                loadAdminSlideshowImages(); // Refresh the table
                setTimeout(closeAddSlideshowImageModal, 1500);
            } else {
                messageDiv.textContent = response.message || 'เกิดข้อผิดพลาดในการเพิ่มรูปภาพ';
                messageDiv.className = 'px-6 py-2 text-sm text-red-600';
            }
        })
        .withFailureHandler(function(error) {
            messageDiv.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
            messageDiv.className = 'px-6 py-2 text-sm text-red-600';
        })
        .addSlideshowImage(imageData);
}

function openEditSlideshowImageModal(id, imageUrl, title, displayOrder, isActive) {
    const modal = document.getElementById('editSlideshowImageModal');
    if (modal) {
        document.getElementById('editSlideshowImageId').value = id;
        document.getElementById('editSlideshowImageUrl').value = imageUrl;
        document.getElementById('editSlideshowImageTitle').value = title;
        document.getElementById('editSlideshowImageOrder').value = displayOrder;
        document.getElementById('editSlideshowImageIsActive').checked = isActive; // isActive is already boolean
        document.getElementById('editSlideshowImageModalMessage').textContent = '';
        modal.classList.remove('hidden');
    } else {
        console.error("Edit Slideshow Image Modal not found.");
    }
}

function closeEditSlideshowImageModal() {
    const modal = document.getElementById('editSlideshowImageModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function saveEditSlideshowImage() {
    const id = document.getElementById('editSlideshowImageId').value;
    const imageUrl = document.getElementById('editSlideshowImageUrl').value.trim();
    const title = document.getElementById('editSlideshowImageTitle').value.trim();
    const displayOrder = parseInt(document.getElementById('editSlideshowImageOrder').value);
    const isActive = document.getElementById('editSlideshowImageIsActive').checked;
    const messageDiv = document.getElementById('editSlideshowImageModalMessage');

    // Add validation similar to saveNewSlideshowImage if needed

    messageDiv.textContent = 'กำลังบันทึกการเปลี่ยนแปลง...';
    messageDiv.className = 'px-6 py-2 text-sm text-blue-600';

    const imageData = { imageUrl, title, displayOrder, isActive };

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageDiv.textContent = response.message || 'อัปเดตข้อมูลสำเร็จ!';
                messageDiv.className = 'px-6 py-2 text-sm text-green-600';
                loadAdminSlideshowImages(); // Refresh table
                setTimeout(closeEditSlideshowImageModal, 1500);
            } else {
                messageDiv.textContent = response.message || 'เกิดข้อผิดพลาดในการอัปเดต';
                messageDiv.className = 'px-6 py-2 text-sm text-red-600';
            }
        })
        .withFailureHandler(function(error) {
            messageDiv.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
            messageDiv.className = 'px-6 py-2 text-sm text-red-600';
        })
        .updateSlideshowImage(id, imageData);
}

function deleteSlideshowImage(id) {
    console.log("deleteSlideshowImage called. Type of showAppConfirmationDialog:", typeof showAppConfirmationDialog);
    showAppConfirmationDialog(
        `คุณแน่ใจหรือไม่ว่าต้องการลบรูปภาพ ID: ${id}? การกระทำนี้ไม่สามารถย้อนกลับได้`,
        function() { // onConfirm
            const messageDiv = document.getElementById('slideshowImagesTableMessageAdmin');
            if(messageDiv) {
                messageDiv.textContent = `กำลังลบรูปภาพ ID: ${id}...`;
                messageDiv.className = 'mt-2 text-sm text-blue-600';
            }

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showAppToastNotification(response.message || 'ลบรูปภาพสไลด์โชว์สำเร็จ!', 'success');
                        loadAdminSlideshowImages(); // Refresh table
                    } else {
                        showAppToastNotification(response.message || 'เกิดข้อผิดพลาดในการลบรูปภาพ', 'error');
                    }
                    if(messageDiv) messageDiv.textContent = ''; // Clear "Deleting..." message
                })
                .withFailureHandler(function(error) {
                    showAppToastNotification('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message, 'error');
                    if(messageDiv) messageDiv.textContent = ''; // Clear "Deleting..." message
                })
                .deleteSlideshowImage(id);
        }
    );
}
// --- END Slideshow Image Modal Functions ---

document.addEventListener('DOMContentLoaded', function() {
    console.log("Settings script: DOMContentLoaded fired.");

    const runInitializeSystemBtn = document.getElementById('runInitializeSystemBtn');
    if (runInitializeSystemBtn) {
        console.log("Settings script: Found runInitializeSystemBtn, attaching listener.");
        // runInitializeSystemBtn.addEventListener('click', handleInitializeSystem); // Now handled by initializeSettingsPageInteractions
    } else {
        console.error("Settings script: runInitializeSystemBtn NOT FOUND.");
    }

    const saveGeneralSettingsBtn = document.getElementById('saveGeneralSettingsBtn');
    if (saveGeneralSettingsBtn) {
        // console.log("Settings script: Found saveGeneralSettingsBtn, attaching listener.");
        saveGeneralSettingsBtn.addEventListener('click', handleSaveGeneralSettings);
    } else {
        // console.error("Settings script: saveGeneralSettingsBtn NOT FOUND.");
    }

    // ใน js/settings.js - ภายในส่วนที่ตั้งค่า Event Listeners
    const saveThemeButton = document.getElementById('saveThemeSettingsBtn');
    if (saveThemeButton) {
        // ลบ Event Listener เก่า (ถ้ามี) หรือแก้ไข Listener เดิม
        // Event listener for saveSelectedTheme will be correctly attached.
        saveThemeButton.addEventListener('click', saveSelectedTheme);
    } else {
        console.error("ไม่พบปุ่ม 'saveThemeSettingsBtn'");
    }
    
    
    // Display settings event listeners
    const displayTypeVideo = document.getElementById('displayTypeVideo');
    const displayTypeSlideshow = document.getElementById('displayTypeSlideshow');
    const saveDisplaySettingsBtn = document.getElementById('saveDisplaySettingsBtn');
    
    if (displayTypeVideo && displayTypeSlideshow) {
        displayTypeVideo.addEventListener('change', toggleDisplaySettingsSections);
        displayTypeSlideshow.addEventListener('change', toggleDisplaySettingsSections);
    }
    
    if (saveDisplaySettingsBtn) {
        saveDisplaySettingsBtn.addEventListener('click', handleSaveDisplaySettings);
    }
    
    const addSoundBtn = document.getElementById('addSoundBtn');
    if (addSoundBtn) {
        // console.log("Settings script: Found addSoundBtn, attaching listener.");
        addSoundBtn.addEventListener('click', handleAddSound);
    }
    const saveEditSoundBtn = document.getElementById('saveEditSoundBtn');
    if (saveEditSoundBtn) {
        saveEditSoundBtn.addEventListener('click', handleSaveEditSound);
    }
    const cancelEditSoundBtn = document.getElementById('cancelEditSoundBtn');
    if (cancelEditSoundBtn) {
        cancelEditSoundBtn.addEventListener('click', () => {
            const editModal = document.getElementById('editSoundModal');
            if (editModal) editModal.classList.add('hidden');
        });
    } else {
        // console.error("Settings script: cancelEditSoundBtn NOT FOUND (modal button).");
    }

    // Google Drive Sound Guide Modal
    const openGoogleDriveGuideBtn = document.getElementById('openGoogleDriveSoundGuideBtn');
    const closeGoogleDriveGuideBtn = document.getElementById('closeGoogleDriveSoundGuideBtn');
    const googleDriveSoundGuideModal = document.getElementById('googleDriveSoundGuideModal');

    if (openGoogleDriveGuideBtn && closeGoogleDriveGuideBtn && googleDriveSoundGuideModal) {
        openGoogleDriveGuideBtn.addEventListener('click', () => {
            googleDriveSoundGuideModal.classList.remove('hidden');
        });
        closeGoogleDriveGuideBtn.addEventListener('click', () => {
            googleDriveSoundGuideModal.classList.add('hidden');
        });
        // Close modal if clicking outside of it
        googleDriveSoundGuideModal.addEventListener('click', (event) => {
            if (event.target === googleDriveSoundGuideModal) {
                googleDriveSoundGuideModal.classList.add('hidden');
            }
        });
    } else {
        console.warn("Settings script: Google Drive sound guide modal elements not all found.");
    }

    const saveAnnouncementSettingsBtn = document.getElementById('saveAnnouncementSettingsBtn');
    if (saveAnnouncementSettingsBtn) {
        saveAnnouncementSettingsBtn.addEventListener('click', handleSaveAnnouncementSettings);
    } else {
        console.error("Settings script: saveAnnouncementSettingsBtn NOT FOUND.");
    }

    
    // Queue Ticket Settings event listeners
    const saveQueueTicketSettingsBtn = document.getElementById('saveQueueTicketSettingsBtn');
    if (saveQueueTicketSettingsBtn) {
        saveQueueTicketSettingsBtn.addEventListener('click', handleSaveQueueTicketSettings);
    } else {
        console.error("Settings script: saveQueueTicketSettingsBtn NOT FOUND.");
    }

    // Initial data loading is now solely handled by onShowSettingsSection()
    // when the settingsSection is explicitly shown.
    // if (document.getElementById('settingsSection') && !document.getElementById('settingsSection').classList.contains('hidden')) {
    //     loadGeneralSettings();
    //     loadSoundData();
    // }
    // Tab switching logic from DOMContentLoaded is now handled by initializeSettingsPageInteractions
    // const tabButtons = document.querySelectorAll('.settings-tab-button');
    // const tabPanes = document.querySelectorAll('.settings-tab-pane');
    // ... (old tab logic removed for brevity, as initializeSettingsPageInteractions handles it)

    // const initialTabButton = document.getElementById('init-system-tab');
    // if (initialTabButton && tabButtons.length > 0 && tabPanes.length > 0) { ... } // Also handled by initializeSettingsPageInteractions

    // --- Slideshow Image Modal Event Listeners ---
    const openAddBtn = document.getElementById('openAddSlideshowImageModalBtn');
    if(openAddBtn) openAddBtn.addEventListener('click', openAddSlideshowImageModal);

    const cancelAddBtn = document.getElementById('cancelNewSlideshowImageBtn');
    if(cancelAddBtn) cancelAddBtn.addEventListener('click', closeAddSlideshowImageModal);

    const saveNewBtn = document.getElementById('saveNewSlideshowImageBtn');
    if(saveNewBtn) saveNewBtn.addEventListener('click', saveNewSlideshowImage);

    const cancelEditBtn = document.getElementById('cancelEditSlideshowImageBtn');
    if(cancelEditBtn) cancelEditBtn.addEventListener('click', closeEditSlideshowImageModal);

    const saveEditBtn = document.getElementById('saveEditSlideshowImageBtn');
    if(saveEditBtn) saveEditBtn.addEventListener('click', saveEditSlideshowImage);

    const closeViewBtn = document.getElementById('closeViewSlideshowImageModalBtn');
    if(closeViewBtn) closeViewBtn.addEventListener('click', closeViewSlideshowImageModal);
    
    const viewModal = document.getElementById('viewSlideshowImageModal');
    if (viewModal) viewModal.addEventListener('click', function(event) {
        if (event.target === viewModal) closeViewSlideshowImageModal(); // Close if backdrop is clicked
    });

   
});
console.log("Settings script: Main event listener for DOMContentLoaded is set.");


function handleInitializeSystem() {
    const initSystemMessageEl = document.getElementById('initSystemMessage');
    const currentInitSystemBtn = document.getElementById('runInitializeSystemBtn'); // Get the button element

    initSystemMessageEl.textContent = 'กำลังดำเนินการเริ่มต้นระบบ...';
    initSystemMessageEl.className = 'mt-3 text-sm text-yellow-700';
     if(currentInitSystemBtn) currentInitSystemBtn.disabled = true;

    google.script.run
        .withSuccessHandler(function(response) {
            // Assuming response is a string from initializeSystem
            initSystemMessageEl.textContent = response || 'ดำเนินการเริ่มต้นระบบสำเร็จ!';
            console.log("Settings script: initializeSystem success:", response);
            initSystemMessageEl.className = 'mt-3 text-sm text-green-700';
           if(currentInitSystemBtn) currentInitSystemBtn.disabled = false;



        })
        .withFailureHandler(function(error) {
            initSystemMessageEl.textContent = 'เกิดข้อผิดพลาดในการเริ่มต้นระบบ: ' + error.message;
            console.error("Settings script: initializeSystem failure:", error);
            initSystemMessageEl.className = 'mt-3 text-sm text-red-700';
        })
        .initializeSystem();
}
console.log("Settings script: handleInitializeSystem function defined.");

function loadGeneralSettings() {
    const messageEl = document.getElementById('generalSettingsMessage');
    if (!messageEl) { console.error("loadGeneralSettings: messageEl not found"); return; }
    
    let currentSettings = {}; // To store settings for later use, like setting ActiveSoundSet
    messageEl.textContent = 'กำลังโหลดการตั้งค่าทั่วไป...';
    messageEl.className = 'mt-3 text-sm text-blue-700';

    google.script.run
        .withSuccessHandler(function(settings) {
            if (settings) {
                const orgNameInput = document.getElementById('orgNameInput');
                const activeSoundSetSelect = document.getElementById('activeSoundSetInput');
                // const soundUrlInput = document.getElementById('soundUrlInput'); // Removed as it's not in General Settings tab
                // New announcement settings fields
                const announcementPatternInput = document.getElementById('announcementPatternInput');
                // Sound Generation Method Radio Buttons
                const soundMethodUrlRadio = document.getElementById('soundMethodUrl');
                const soundMethodWebSpeechRadio = document.getElementById('soundMethodWebSpeech');
                const soundMethodGoogleTTSRadio = document.getElementById('soundMethodGoogleTTS');
                const counterAnnounceNumberRadio = document.getElementById('counterAnnounceNumber');
                const counterAnnounceNameSoundRadio = document.getElementById('counterAnnounceNameSound');

                currentSettings = settings; // Store settings
                if(orgNameInput) orgNameInput.value = settings.OrganizationName || ''; else console.error("loadGeneralSettings: orgNameInput not found");
                // ActiveSoundSet will be set after its options are loaded
                // if(soundUrlInput) soundUrlInput.value = settings.SoundURL || ''; else console.error("loadGeneralSettings: soundUrlInput not found"); // Removed
                
                // Populate announcement settings
                if(announcementPatternInput) announcementPatternInput.value = settings.default_announcement_pattern || ''; else console.error("loadGeneralSettings: announcementPatternInput not found");
                if(counterAnnounceNumberRadio && counterAnnounceNameSoundRadio) {
                    if (settings.counter_announcement_type === 'name_sound') {
                        counterAnnounceNameSoundRadio.checked = true;
                    } else {
                        counterAnnounceNumberRadio.checked = true; // Default to number
                    }
                } else { console.error("loadGeneralSettings: Counter announcement radio buttons not found"); }

                // Populate Sound Generation Method
                if (soundMethodUrlRadio && soundMethodWebSpeechRadio && soundMethodGoogleTTSRadio) {
                    switch (settings.SoundGenerationMethod) {
                        case 'web_speech':
                            soundMethodWebSpeechRadio.checked = true;
                            break;
                        case 'google_cloud_tts':
                            soundMethodGoogleTTSRadio.checked = true;
                            break;
                        default: // 'url' or undefined
                            soundMethodUrlRadio.checked = true;
                    }
                } else { console.error("loadGeneralSettings: Sound Generation Method radio buttons not found"); }

                // Also load display settings
                loadDisplaySettings(settings);

                // Load Queue Ticket Settings
                const autoPrintEnabledRadio = document.getElementById('autoPrintEnabled');
                const autoPrintDisabledRadio = document.getElementById('autoPrintDisabled');
                const ticketTitleInput = document.getElementById('ticketTitleInput');
                const ticketWidthInput = document.getElementById('ticketWidthInput');
                const ticketHeightInput = document.getElementById('ticketHeightInput');

                if(autoPrintEnabledRadio && autoPrintDisabledRadio) {
                    if (settings.AutoPrintEnabled === 'enabled') autoPrintEnabledRadio.checked = true; else autoPrintDisabledRadio.checked = true;
                } else console.error("loadGeneralSettings: AutoPrint radio buttons not found");
                if(ticketTitleInput) ticketTitleInput.value = settings.TicketTitle || 'บัตรคิว'; else console.error("loadGeneralSettings: ticketTitleInput not found");
                if(ticketWidthInput) ticketWidthInput.value = settings.TicketWidth || '80'; else console.error("loadGeneralSettings: ticketWidthInput not found");
                if(ticketHeightInput) ticketHeightInput.value = settings.TicketHeight || '150'; else console.error("loadGeneralSettings: ticketHeightInput not found");

                loadThemeSettings(settings); // <<<< ADD THIS LINE
                
                messageEl.textContent = 'โหลดการตั้งค่าทั่วไปสำเร็จ';
                setTimeout(() => { messageEl.textContent = ''; }, 3000);
            } else {
                messageEl.textContent = 'ไม่พบข้อมูลการตั้งค่า';
                messageEl.className = 'mt-3 text-sm text-yellow-700';
            }

            // Now load available sound sets and set the active one
            google.script.run.withSuccessHandler(function(soundSetResponse) {
                const activeSoundSetSelect = document.getElementById('activeSoundSetInput');
                if (activeSoundSetSelect) {
                    if (soundSetResponse.success && soundSetResponse.data) {
                        activeSoundSetSelect.innerHTML = '<option value="">-- เลือกชุดเสียง --</option>'; // Clear existing
                        soundSetResponse.data.forEach(set => {
                            const option = document.createElement('option');
                            option.value = set;
                            option.textContent = set;
                            activeSoundSetSelect.appendChild(option);
                        });
                        // Set the current active sound set from previously loaded settings
                        if (currentSettings.ActiveSoundSet) {
                            activeSoundSetSelect.value = currentSettings.ActiveSoundSet;
                        }
                    } else {
                        activeSoundSetSelect.innerHTML = '<option value="">ไม่สามารถโหลดชุดเสียง</option>';
                        console.error("Failed to load sound sets:", soundSetResponse.message);
                    }
                }
            }).withFailureHandler(showError).getAvailableSoundSets();

        })
        .withFailureHandler(function(error) {
            if(messageEl) {
                messageEl.textContent = 'ไม่พบข้อมูลการตั้งค่า';
                messageEl.className = 'mt-3 text-sm text-yellow-700';
            }
        })
        .withFailureHandler(function(error) {
            if(messageEl) {
                messageEl.textContent = 'เกิดข้อผิดพลาดในการโหลดการตั้งค่า: ' + error.message;
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .getSettings();
}

function loadDisplaySettings(settings) {
    // Get display settings elements
    const displayTypeVideo = document.getElementById('displayTypeVideo');
    const displayTypeSlideshow = document.getElementById('displayTypeSlideshow');
    const mediaUrlInput = document.getElementById('mediaUrlInput');
    const slideshowIntervalInput = document.getElementById('slideshowIntervalInput');
    const slideshowTransitionInput = document.getElementById('slideshowTransitionInput');
    const manageSlideshowImagesBtn = document.getElementById('manageSlideshowImagesBtn');
    
    // Set display type radio buttons
    if (displayTypeVideo && displayTypeSlideshow) {
        // Default to video if MediaURL is set, otherwise slideshow
        const hasMediaUrl = settings.MediaURL && settings.MediaURL.trim() !== '';
        
        if (settings.DisplayType === 'slideshow') {
            displayTypeSlideshow.checked = true;
        } else {
            displayTypeVideo.checked = true; // Default to video
        }
        
        // Toggle visibility of settings sections based on selected type
        toggleDisplaySettingsSections();
    }
    
    // Set other display settings
    if (mediaUrlInput) mediaUrlInput.value = settings.MediaURL || '';
    if (slideshowIntervalInput) slideshowIntervalInput.value = settings.SlideshowInterval || 7;
    if (slideshowTransitionInput && settings.SlideshowTransition) {
        slideshowTransitionInput.value = settings.SlideshowTransition;
    }
    
    // Add event listener for the "View Slideshow Images" button
    if (manageSlideshowImagesBtn) {
        manageSlideshowImagesBtn.addEventListener('click', function(e) {
            e.preventDefault();
            viewSlideshowImages();
        });
    }
}

// Function to view slideshow images from the SlideshowImages sheet
function viewSlideshowImages() {
    const messageEl = document.getElementById('displaySettingsMessage');
    if (messageEl) {
        messageEl.textContent = 'กำลังโหลดข้อมูลรูปภาพสไลด์โชว์...';
        messageEl.className = 'mt-3 text-sm text-purple-700';
    }
    
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success && response.data && response.data.length > 0) {
                // Create a modal to display the images
                const modal = document.createElement('div');
                modal.className = 'fixed z-50 inset-0 overflow-y-auto';
                modal.innerHTML = `
                    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
                        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                <div class="sm:flex sm:items-start">
                                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                                        <h3 class="text-lg leading-6 font-medium text-gray-900">รูปภาพสไลด์โชว์ทั้งหมด</h3>
                                        <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                            ${response.data.map(img => `
                                                <div class="border rounded-lg overflow-hidden">
                                                    <img src="${img.imageUrl}" alt="${img.title || 'Slideshow Image'}" class="w-full h-40 object-cover">
                                                    <div class="p-2 bg-gray-50">
                                                        <p class="text-sm font-medium">${img.title || 'ไม่มีชื่อ'}</p>
                                                        <p class="text-xs text-gray-500">ลำดับ: ${img.displayOrder || 0}</p>
                                                        <p class="text-xs text-gray-500">สถานะ: ${img.isActive ? 'แสดง' : 'ไม่แสดง'}</p>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        <p class="mt-4 text-sm text-gray-500">หมายเหตุ: การแก้ไขรูปภาพสไลด์โชว์ต้องทำผ่านชีท "SlideshowImages" โดยตรง</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                                <button type="button" class="close-modal-btn mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                    ปิด
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Add event listener to close button
                modal.querySelector('.close-modal-btn').addEventListener('click', function() {
                    document.body.removeChild(modal);
                });
                
                if (messageEl) {
                    messageEl.textContent = '';
                }
            } else {
                if (messageEl) {
                    messageEl.textContent = response.message || 'ไม่พบข้อมูลรูปภาพสไลด์โชว์';
                    messageEl.className = 'mt-3 text-sm text-yellow-600';
                }
            }
        })
        .withFailureHandler(function(error) {
            if (messageEl) {
                messageEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูลรูปภาพ: ' + error.message;
                messageEl.className = 'mt-3 text-sm text-red-600';
            }
        })
        .getAllSlideshowImagesAdmin();
}

function toggleDisplaySettingsSections() {
    const videoSection = document.getElementById('videoSettingsSection');
    const slideshowSection = document.getElementById('slideshowSettingsSection');
    const displayTypeVideo = document.getElementById('displayTypeVideo');
    
    if (videoSection && slideshowSection && displayTypeVideo) {
        if (displayTypeVideo.checked) {
            videoSection.style.display = 'block';
            slideshowSection.style.display = 'none';
        } else {
            videoSection.style.display = 'none';
            slideshowSection.style.display = 'block';
        }
    }
}

function handleSaveGeneralSettings() {
    const messageEl = document.getElementById('generalSettingsMessage');
    if (!messageEl) { console.error("handleSaveGeneralSettings: messageEl not found"); return; }
    
    const activeSoundSetInput = document.getElementById('activeSoundSetInput'); // Get the select element
    const orgNameInput = document.getElementById('orgNameInput');
    // Removed checks for soundUrlInput and Sound Generation Method radios
    // as they are not in the General Settings tab and should be saved elsewhere.

    // Check only for elements expected in the General Settings tab


    if (!orgNameInput || !activeSoundSetInput /* Removed soundUrlInput and soundMethod radios from this check */) {
        messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบช่องข้อมูลบางช่อง';
        messageEl.className = 'mt-3 text-sm text-red-700';
        console.error("handleSaveGeneralSettings: One or more input fields (org, soundURL, soundMethod radios) not found.");
        return;
    }

    messageEl.textContent = 'กำลังบันทึกการตั้งค่า...';
    messageEl.className = 'mt-3 text-sm text-blue-700';

    const settingsToUpdate = {
        OrganizationName: orgNameInput.value.trim(),
        // Removed SoundURL and SoundGenerationMethod from here
        ActiveSoundSet: activeSoundSetInput ? activeSoundSetInput.value : (currentSettings.ActiveSoundSet || 'madamdear') // Save ActiveSoundSet
    };
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการตั้งค่าสำเร็จ!';
                messageEl.className = 'mt-3 text-sm text-green-700';
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาดในการบันทึก: ' + error.message;
            messageEl.className = 'mt-3 text-sm text-red-700';
        })
        .updateMultipleSettings(settingsToUpdate); // Using the new batch update function
}

function handleSaveDisplaySettings() {
    const messageEl = document.getElementById('displaySettingsMessage');
    if (!messageEl) { console.error("handleSaveDisplaySettings: messageEl not found"); return; }

    const displayTypeVideo = document.getElementById('displayTypeVideo');
    const mediaUrlInput = document.getElementById('mediaUrlInput');
    // slideshowUrlsInput is no longer needed as we use SlideshowImages sheet
    const slideshowIntervalInput = document.getElementById('slideshowIntervalInput');
    const slideshowTransitionInput = document.getElementById('slideshowTransitionInput');

    if (!displayTypeVideo || !mediaUrlInput || !slideshowIntervalInput || !slideshowTransitionInput) {
        messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์มบางส่วน';
        messageEl.className = 'mt-3 text-sm text-red-700';
        console.error("handleSaveDisplaySettings: One or more form elements not found.");
        return;
    }

    messageEl.textContent = 'กำลังบันทึกการตั้งค่าการแสดงผล...';
    messageEl.className = 'mt-3 text-sm text-purple-700';

    const displayType = displayTypeVideo.checked ? 'video' : 'slideshow';
    const slideshowInterval = parseInt(slideshowIntervalInput.value) || 7;

    const settingsToUpdate = {
        DisplayType: displayType,
        MediaURL: mediaUrlInput.value.trim(),
        SlideshowInterval: slideshowInterval,
        SlideshowTransition: slideshowTransitionInput.value
    };

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการตั้งค่าการแสดงผลสำเร็จ!';
                messageEl.className = 'mt-3 text-sm text-green-700';
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาดในการบันทึก: ' + error.message;
            messageEl.className = 'mt-3 text-sm text-red-700';
        })
        .updateMultipleSettings(settingsToUpdate);
}

function handleSaveAnnouncementSettings() {
    const messageEl = document.getElementById('announcementSettingsMessage');
    if (!messageEl) { console.error("handleSaveAnnouncementSettings: messageEl not found"); return; }

    const patternInput = document.getElementById('announcementPatternInput');
    const announceNumberRadio = document.getElementById('counterAnnounceNumber');
    // Get Sound Generation Method Radio Buttons (These are correctly located in this tab)
    const soundMethodUrlRadio = document.getElementById('soundMethodUrl');
    const soundMethodWebSpeechRadio = document.getElementById('soundMethodWebSpeech');
    const soundMethodGoogleTTSRadio = document.getElementById('soundMethodGoogleTTS');

    if (!patternInput || !announceNumberRadio || !soundMethodUrlRadio || !soundMethodWebSpeechRadio || !soundMethodGoogleTTSRadio) {
        messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์มบางส่วน (pattern, counter announce, sound method radios)';
        messageEl.className = 'mt-3 text-sm text-red-700';
        console.error("handleSaveAnnouncementSettings: One or more form elements not found.");
        return;
    }

    // Determine selected SoundGenerationMethod
    let selectedSoundMethod = 'url'; // Default
    if (soundMethodWebSpeechRadio.checked) selectedSoundMethod = 'web_speech';
    else if (soundMethodGoogleTTSRadio.checked) selectedSoundMethod = 'google_cloud_tts';

    messageEl.textContent = 'กำลังบันทึกการตั้งค่ารูปแบบเสียง...';
    messageEl.className = 'mt-3 text-sm text-blue-700';

    const settingsToUpdate = {
        default_announcement_pattern: patternInput.value.trim(),
        counter_announcement_type: announceNumberRadio.checked ? 'number' : 'name_sound',
        SoundGenerationMethod: selectedSoundMethod // Add SoundGenerationMethod here
    };

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการตั้งค่ารูปแบบเสียงสำเร็จ!';
                messageEl.className = 'mt-3 text-sm text-green-700';
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาดในการบันทึก: ' + error.message;
            messageEl.className = 'mt-3 text-sm text-red-700';
        })
        .updateMultipleSettings(settingsToUpdate);
}

function handleSaveQueueTicketSettings() {
    const messageEl = document.getElementById('queueTicketSettingsMessage');
    if (!messageEl) { console.error("handleSaveQueueTicketSettings: messageEl not found"); return; }

    const autoPrintEnabledRadio = document.getElementById('autoPrintEnabled');
    const ticketTitleInput = document.getElementById('ticketTitleInput');
    const ticketWidthInput = document.getElementById('ticketWidthInput');
    const ticketHeightInput = document.getElementById('ticketHeightInput');

    if (!autoPrintEnabledRadio || !ticketTitleInput || !ticketWidthInput || !ticketHeightInput) {
        messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์มบางส่วน';
        messageEl.className = 'mt-3 text-sm text-red-700';
        console.error("handleSaveQueueTicketSettings: One or more form elements not found.");
        return;
    }

    messageEl.textContent = 'กำลังบันทึกการตั้งค่าบัตรคิว...';
    messageEl.className = 'mt-3 text-sm text-amber-700';

    const ticketWidth = parseInt(ticketWidthInput.value) || 80; // Default to 80mm if invalid
    const ticketHeight = parseInt(ticketHeightInput.value) || 150; // Default to 150mm if invalid

    const settingsToUpdate = {
        AutoPrintEnabled: autoPrintEnabledRadio.checked ? 'enabled' : 'disabled',
        TicketTitle: ticketTitleInput.value.trim() || 'บัตรคิว',
        TicketWidth: ticketWidth.toString(),
        TicketHeight: ticketHeight.toString()
    };

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการตั้งค่าบัตรคิวสำเร็จ!';
                messageEl.className = 'mt-3 text-sm text-green-700';
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาดในการบันทึก: ' + error.message;
            messageEl.className = 'mt-3 text-sm text-red-700';
        })
        .updateMultipleSettings(settingsToUpdate);
}

function loadSoundData() {
    const tableBody = document.getElementById('soundTableBody');
    const messageEl = document.getElementById('soundTableMessage');
    if (!tableBody) { console.error("loadSoundData: tableBody not found"); return; }
    if (!messageEl) { console.error("loadSoundData: messageEl not found"); }

    // ... rest of loadSoundData
    tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">กำลังโหลดข้อมูลเสียง...</td></tr>'; // Adjusted colspan for 6 columns
    if(messageEl) messageEl.textContent = '';

    const colspanForSoundTable = 7; // ID, Name, Link, Desc, Type, Set, Actions
    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success && response.data) {
                tableBody.innerHTML = ''; 
                if (response.data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${colspanForSoundTable}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">ไม่พบข้อมูลเสียง</td></tr>`;
                } else {
                    response.data.forEach(sound => {
                        const row = tableBody.insertRow();
                        // Added Description and Sound Type columns
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sound.id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sound.nameSound}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs" title="${sound.linkSound}">${sound.linkSound}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sound.description || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sound.soundType || ''}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${sound.soundSet || 'default'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                <button onclick="openEditSoundModal('${sound.id}', '${escapeJsString(sound.nameSound)}', '${escapeJsString(sound.linkSound)}', '${escapeJsString(sound.description)}', '${escapeJsString(sound.soundType)}', '${escapeJsString(sound.soundSet)}')" class="text-indigo-600 hover:text-indigo-900 mr-2">แก้ไข</button>
                                <button onclick="handleDeleteSound('${sound.id}')" class="text-red-600 hover:text-red-900">ลบ</button>
                            </td>
                        `;
                    });
                }
                if(messageEl) messageEl.textContent = 'โหลดข้อมูลเสียงสำเร็จ';
            } else {
                tableBody.innerHTML = `<tr><td colspan="${colspanForSoundTable}" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">เกิดข้อผิดพลาด: ${response.message || 'ไม่สามารถโหลดข้อมูลเสียง'}</td></tr>`;
                if(messageEl) {
                    messageEl.textContent = response.message || 'ไม่สามารถโหลดข้อมูลเสียง';
                    messageEl.className = 'mt-3 text-sm text-red-700';
                }
            }
             if(messageEl) setTimeout(() => { messageEl.textContent = ''; }, 3000);
        })
        .withFailureHandler(function(error) {
            tableBody.innerHTML = `<tr><td colspan="${colspanForSoundTable}" class="px-6 py-4 whitespace-nowrap text-sm text-red-500 text-center">Error: ${error.message}</td></tr>`;
            if(messageEl) {
                messageEl.textContent = 'เกิดข้อผิดพลาดในการโหลดข้อมูลเสียง: ' + error.message;
                messageEl.className = 'mt-3 text-sm text-red-700';
            }
        })
        .getAllSoundData();
}

function escapeJsString(str) {
    if (typeof str !== 'string') return '';
    return str.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
}

function handleAddSound() {
    const nameInput = document.getElementById('newSoundName');
    const linkInput = document.getElementById('newSoundLink');
    const descriptionInput = document.getElementById('newSoundDescription'); // Assuming you add this input
    const typeInput = document.getElementById('newSoundType');       // Assuming you add this select/input
    const soundSetInput = document.getElementById('newSoundSet'); // Added for Sound Set
    const messageEl = document.getElementById('addSoundMessage');

    if (!nameInput || !linkInput || !descriptionInput || !typeInput || !soundSetInput || !messageEl) {
        console.error("handleAddSound: One or more form elements not found (name, link, desc, type, set, messageEl).");
        if(messageEl) messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์ม';
        return;
    }

    const nameSound = nameInput.value.trim();
    const linkSound = linkInput.value.trim();
    const description = descriptionInput.value.trim();
    const soundType = typeInput.value.trim();
    const soundSet = soundSetInput.value.trim() || 'default'; // Default if empty

    if (!nameSound || !linkSound || !soundType) { // Basic validation, soundType is also important
        messageEl.textContent = 'กรุณากรอกชื่อเสียงและลิงก์เสียง';
        messageEl.className = 'mt-2 text-sm text-red-700';
        return;
    }

    messageEl.textContent = 'กำลังเพิ่มเสียง...';
    messageEl.className = 'mt-2 text-sm text-blue-700';

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'เพิ่มเสียงสำเร็จ!';
                messageEl.className = 'mt-2 text-sm text-green-700';
                nameInput.value = '';
                linkInput.value = '';
                descriptionInput.value = '';
                typeInput.value = 'general_purpose'; // Reset to default
                soundSetInput.value = ''; // Reset sound set input
                loadSoundData(); 
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการเพิ่มเสียง';
                messageEl.className = 'mt-2 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
            messageEl.className = 'mt-2 text-sm text-red-700';
        })
        .addSoundData(nameSound, linkSound, description, soundType, soundSet); // Pass soundSet
}

function openEditSoundModal(id, name, link, description, soundType, soundSet) { // Added soundSet
    const editSoundId = document.getElementById('editSoundId');
    const editSoundNameInput = document.getElementById('editSoundNameInput');
    const editSoundLinkInput = document.getElementById('editSoundLinkInput');
    const editSoundDescriptionInput = document.getElementById('editSoundDescriptionInput'); // Assuming you add this
    const editSoundTypeInput = document.getElementById('editSoundTypeInput');       // Assuming you add this
    const editSoundSetInput = document.getElementById('editSoundSetInput'); // Added for Sound Set
    const editSoundModalMessage = document.getElementById('editSoundModalMessage');
    const editSoundModal = document.getElementById('editSoundModal');

    if (!editSoundId || !editSoundNameInput || !editSoundLinkInput || !editSoundDescriptionInput || !editSoundTypeInput || !editSoundSetInput || !editSoundModalMessage || !editSoundModal) {
        console.error("openEditSoundModal: One or more modal elements not found (id, name, link, desc, type, set, message, modal).");
        alert("Error opening edit modal.");
        return;
    }

    editSoundId.value = id;
    editSoundNameInput.value = name || '';
    editSoundLinkInput.value = link || '';
    editSoundDescriptionInput.value = description || ''; // Default to empty string if null/undefined
    editSoundTypeInput.value = soundType || 'general_purpose'; // Default if null/undefined
    editSoundSetInput.value = soundSet || 'default'; // Default if null/undefined
    editSoundModalMessage.textContent = '';
    editSoundModal.classList.remove('hidden');
}

function handleSaveEditSound() {
    const id = document.getElementById('editSoundId').value;
    const nameInput = document.getElementById('editSoundNameInput');
    const linkInput = document.getElementById('editSoundLinkInput');
    const descriptionInput = document.getElementById('editSoundDescriptionInput'); // Assuming you add this
    const typeInput = document.getElementById('editSoundTypeInput');       // Assuming you add this
    const soundSetInput = document.getElementById('editSoundSetInput'); // Added for Sound Set
    const messageEl = document.getElementById('editSoundModalMessage');
    const editModal = document.getElementById('editSoundModal');


    if (!nameInput || !linkInput || !descriptionInput || !typeInput || !soundSetInput || !messageEl || !editModal) {
        console.error("handleSaveEditSound: One or more modal form elements not found (name, link, desc, type, set, message, modal).");
        if(messageEl) messageEl.textContent = 'เกิดข้อผิดพลาด: ไม่พบองค์ประกอบฟอร์มโมดัล';
        return;
    }

    const nameSound = nameInput.value.trim();
    const linkSound = linkInput.value.trim();
    const description = descriptionInput.value.trim();
    const soundType = typeInput.value.trim();
    const soundSet = soundSetInput.value.trim() || 'default'; // Default if empty

    if (!nameSound || !linkSound || !soundType) { // Basic validation, soundType is also important
        messageEl.textContent = 'กรุณากรอกชื่อเสียงและลิงก์เสียง';
        messageEl.className = 'px-6 py-2 text-sm text-red-700';
        return;
    }

    messageEl.textContent = 'กำลังบันทึกการแก้ไข...';
    messageEl.className = 'px-6 py-2 text-sm text-blue-700';

    google.script.run
        .withSuccessHandler(function(response) {
            if (response.success) {
                messageEl.textContent = response.message || 'บันทึกการแก้ไขสำเร็จ!';
                messageEl.className = 'px-6 py-2 text-sm text-green-700';
                setTimeout(() => {
                    editModal.classList.add('hidden');
                    loadSoundData(); 
                }, 1500);
            } else {
                messageEl.textContent = response.message || 'เกิดข้อผิดพลาดในการบันทึก';
                messageEl.className = 'px-6 py-2 text-sm text-red-700';
            }
        })
        .withFailureHandler(function(error) {
            messageEl.textContent = 'เกิดข้อผิดพลาด: ' + error.message;
            messageEl.className = 'px-6 py-2 text-sm text-red-700';
        })
        .updateSoundData(id, nameSound, linkSound, description, soundType, soundSet); // Pass soundSet
}

function handleDeleteSound(id) {
    const messageEl = document.getElementById('soundTableMessage');
    if (!messageEl) { console.error("handleDeleteSound: messageEl not found"); return; }

    showAppConfirmationDialog(
        `คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลเสียง ID: ${id}? การกระทำนี้ไม่สามารถย้อนกลับได้`,
        function() { // onConfirm
            messageEl.textContent = `กำลังลบเสียง ID: ${id}...`;
            messageEl.className = 'mt-3 text-sm text-blue-700';

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        showAppToastNotification(response.message || 'ลบข้อมูลเสียงสำเร็จ!', 'success');
                        loadSoundData(); // Refresh table
                    } else {
                        showAppToastNotification(response.message || 'เกิดข้อผิดพลาดในการลบข้อมูลเสียง', 'error');
                    }
                    messageEl.textContent = ''; // Clear "Deleting..." message
                })
                .withFailureHandler(function(error) {
                    showAppToastNotification('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message, 'error');
                    messageEl.textContent = ''; // Clear "Deleting..." message
                })
                .deleteSoundData(id);
        },
        function() { // onCancel
            if (messageEl) messageEl.textContent = ''; // Clear any previous messages if cancelled
        }
    );
}

// Function to be called when settingsSection becomes visible
function onShowSettingsSection() {
    console.log("Settings section shown, loading data...");
     initializeSettingsPageInteractions(); // Initialize or re-initialize interactions
    loadGeneralSettings();
    loadSoundData(); // Make sure this function is defined and working
    loadAdminSlideshowImages(); // Load slideshow images when settings are shown
    // Add loading for Announcement Settings tab if you create one
}
// Make sure onShowSettingsSection is called when the settings tab/section is actually made visible by your main navigation logic.
// d:\Github\Queue-augment\js\settings.js

// --- Theme Settings ---
    function loadThemeSettings(settings) {
       // ให้แทนที่โค้ดเดิมที่พยายามตั้งค่า radio button ของ theme ด้วยบรรทัดนี้:
if (settings.ActiveTheme) {
    populateActiveThemeDropdown(settings.ActiveTheme);
} else {
    populateActiveThemeDropdown('standard'); // ถ้าไม่มีค่า ActiveTheme ให้ใช้ standard
}
    }

    function saveThemeSettings() {
        const selectedTheme = document.querySelector('input[name="active_theme_option"]:checked');
        const messageDiv = document.getElementById('themeSettingsMessage');
        messageDiv.textContent = 'กำลังบันทึก...';

        if (selectedTheme) {
            const settingsToUpdate = {
                'ActiveTheme': selectedTheme.value
            };
            google.script.run
                .withSuccessHandler(response => {
                    if (response.success) {
                        messageDiv.textContent = 'บันทึกธีมสำเร็จ! กรุณารีเฟรชหน้าเพื่อดูการเปลี่ยนแปลง';
                        messageDiv.className = 'mt-3 text-sm text-green-600';
                        // Optionally, you can try to dynamically change the theme without a full reload,
                        // but a reload is simpler and more reliable with Apps Script HTML Service.
                        // For immediate effect, you might need to reload the page:
                        // showToast('บันทึกธีมสำเร็จ! จะรีเฟรชหน้าใน 3 วินาที...');
                        // setTimeout(() => window.top.location.reload(), 3000);
                    } else {
                        messageDiv.textContent = 'เกิดข้อผิดพลาด: ' + response.message;
                        messageDiv.className = 'mt-3 text-sm text-red-600';
                    }
                })
                .withFailureHandler(error => { // Changed from showError to a local handler or a defined global one
                    messageDiv.textContent = 'เกิดข้อผิดพลาดในการติดต่อเซิร์ฟเวอร์: ' + error.message;
                    messageDiv.className = 'mt-3 text-sm text-red-600';
                    console.error("saveThemeSettings failure:", error); // Log the error
                })
                .updateMultipleSettings(settingsToUpdate);
        } else {
            messageDiv.textContent = 'กรุณาเลือกธีม';
            messageDiv.className = 'mt-3 text-sm text-red-600';
        }
    }


// Generic error handler function (can be moved to a global script if used elsewhere)
function showError(error) {
    console.error("Script error:", error);
    // You can display this error in a more user-friendly way, e.g., in a dedicated error div or using a toast notification.
    // For now, just logging it. If a specific message div is relevant, update it.
    const generalMessageEl = document.getElementById('generalSettingsMessage') || // Try general settings message
                             document.getElementById('soundTableMessage') ||      // Or sound table message
                             document.getElementById('themeSettingsMessage');     // Or theme settings message
    if (generalMessageEl) {
        generalMessageEl.textContent = 'เกิดข้อผิดพลาด: ' + (error.message || JSON.stringify(error));
        generalMessageEl.className = 'mt-3 text-sm text-red-700';
    } else {
        alert('เกิดข้อผิดพลาด: ' + (error.message || JSON.stringify(error)));
    }
}

// เพิ่มฟังก์ชันนี้ใน js/settings.js
function populateActiveThemeDropdown(activeThemeValue) {
    const themeSelect = document.getElementById('activeThemeSelect');
    if (themeSelect) {
        themeSelect.value = activeThemeValue || 'standard'; // กำหนดค่าเริ่มต้นเป็น 'standard' หากไม่มีค่า
    } else {
        console.error("ไม่พบ Element 'activeThemeSelect' สำหรับการโหลดธีม");
    }
}

// เพิ่มฟังก์ชันนี้ใน js/settings.js
function saveSelectedTheme() {
    const themeMsgDiv = document.getElementById('themeSettingsMessage');
    const activeThemeSelect = document.getElementById('activeThemeSelect');

    if (!activeThemeSelect) {
        console.error("ไม่พบ Element 'activeThemeSelect' สำหรับการบันทึกธีม");
        if (themeMsgDiv) {
            themeMsgDiv.textContent = 'เกิดข้อผิดพลาด: ไม่พบ dropdown เลือกธีม';
            themeMsgDiv.className = 'text-red-500 text-sm mt-3';
        }
        return;
    }
    const selectedThemeValue = activeThemeSelect.value;

    // ตรวจสอบว่ามีการเลือกค่าหรือไม่ (เผื่อกรณีมี option แรกเป็นค่าว่าง)
    if (!selectedThemeValue || selectedThemeValue === "") {
        if (themeMsgDiv) {
            themeMsgDiv.textContent = 'กรุณาเลือกธีมที่ต้องการ';
            themeMsgDiv.className = 'text-red-500 text-sm mt-3';
        }
        return;
    }

    if (themeMsgDiv) {
        themeMsgDiv.textContent = 'กำลังบันทึกธีม...';
        themeMsgDiv.className = 'text-blue-500 text-sm mt-3';
    }

    google.script.run
        .withSuccessHandler(function(response) {
            if (themeMsgDiv) {
                if (response.success) {
                    themeMsgDiv.textContent = 'บันทึกธีมสำเร็จ!';
                    themeMsgDiv.className = 'text-green-500 text-sm mt-3';
                    // (Optional) หากต้องการให้ธีมเปลี่ยนทันทีโดยไม่ต้องรีเฟรชหน้า
                    // อาจจะต้องมีฟังก์ชัน global สำหรับโหลด CSS ของธีมใหม่
                    if (typeof window.loadAndApplyTheme === 'function') {
                        window.loadAndApplyTheme(selectedThemeValue);
                    }
                } else {
                    themeMsgDiv.textContent = 'เกิดข้อผิดพลาดในการบันทึกธีม: ' + (response.message || 'Unknown error');
                    themeMsgDiv.className = 'text-red-500 text-sm mt-3';
                }
            }
        })
        .withFailureHandler(function(error) {
            if (themeMsgDiv) {
                themeMsgDiv.textContent = 'เกิดข้อผิดพลาดในการสื่อสารกับเซิร์ฟเวอร์: ' + error.message;
                themeMsgDiv.className = 'text-red-500 text-sm mt-3';
            }
        })
        .updateMultipleSettings({ 'ActiveTheme': selectedThemeValue });
}


</script>
